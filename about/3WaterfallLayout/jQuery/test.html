<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>带有分散效果的瀑布流</title>
    <style type="text/css">
        *{padding: 0;margin:0;}
    #main{
        position: relative;
    }
    .box{
        padding: 15px 0 0 15px;
        float:left;
    }
    .pic{
        padding: 10px;
        border:1px solid #ccc;
        box-shadow: 0 0 6px #ccc;
        border-radius: 5px;
    }
    .pic img{
        width:162px;
        height:auto;
    }
    </style>
    <script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
    <script>
        var dataInt={'data':[{'src':'images/1.jpg'},{'src':'images/2.jpg'},{'src':'images/3.jpg'},{'src':'images/4.jpg'}]};
        $(window).on('load',function () {
            waterfall();
            $(window).on('scroll',function () {
                if(checkScrollSlide()){
                    $.each(dataInt.data,function (key,value) {
                        var oBox = $('<div>').addClass('box').appendTo($('#main'));
                        var oPic = $('<div>').addClass('pic').appendTo($(oBox));
                        $('<img>').attr('src',$(value).attr('src')).appendTo($(oPic));
                    });
                    waterfall();
                }
            });
        });

        function waterfall() {
            var $boxs = $('#main>div');
            var w = $boxs.eq(0).outerWidth();
            var cols = Math.floor($(window).width()/w);
            $('#main').width(w*cols).css('margin','0 auto');

            var hArr = [];
            $boxs.each(function (index,value) {
                var h = $boxs.eq(index).outerHeight();
                if(index<cols){
                    hArr[index] = h;
                } else {
                    var minH = Math.min.apply(null,hArr);
                    var minHIndex = $.inArray(minH,hArr);
                    $(value).css({
                        'position':'absolute',
                        'top':minH+'px',
                        'left':minHIndex*w+'px'
                    });
                    hArr[minHIndex]+=$boxs.eq(index).outerHeight();
                }
            });

            console.log($boxs.length);
        }


        function checkScrollSlide() {
            var $lastBox = $('#main>div').last();
            var lastBoxDis = $lastBox.offset().top+Math.floor($lastBox.outerHeight()/2);
            var scrollTop = $(window).scrollTop();
            var documentH = $(window).height();
            return (lastBoxDis<scrollTop+documentH)?true:false;
        }

    </script>
</head>
<body>
<div id="main">
    <div class="box">
        <div class="pic">
            <img src="images/1.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/2.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/3.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/4.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/5.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/6.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/7.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/8.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/9.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/10.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/11.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/12.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/13.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/14.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/15.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/16.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/17.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/18.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/19.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/20.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/21.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/19.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/20.jpg"/>
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/21.jpg"/>
        </div>
    </div>
</div>
</body>
</html>